#Read Files

The first step was to read the files and organize them. In each file, some columns had to be translated and some data reordered to facilitate the exploratory analysis work.

```{r echo=FALSE, warning=FALSE, error=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(tidyr)
library(dplyr)
library(lubridate)
library(plyr)
dir.create('processed_files')
```

![data](dados.png)

## Accounts

Here we find the account data. There are 4500 records, each containing information about the account district, frequency of statement issuance, and date of account creation.

To make the data easier to understand, we translate Czech frequency values into English and separate dates with hyphens.


```{r echo = FALSE}
### Account frame
#Load csv
account <- read.csv2("inputs/account.asc",dec = '.')  
#Get date to columns
account <- mutate(account,date = lubridate::make_date(
                  year = paste("19",substring(date,1,2),sep = ""),
                  month = substring(date,3,4),
                  day =substring(date,5,6)))



#Translate names
plyr::revalue(account$frequency, c(
  "POPLATEK MESICNE"= "monthly",
  "POPLATEK TYDNE"="weekly",
  "POPLATEK PO OBRATU" ="after transaction")) -> account$frequency

save(account,file = 'processed_files/account')
knitr::kable(account[1:10,], caption = 'accounts frame')
#datatable(account, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T) )
```

## Clients

The Clients list contains 5369 bank customers, tabulated with the district code and their birthday code - which informs the birthday and gender. For the analysis, we separated the date of birth and gender in separate columns.

```{r echo = FALSE}
#Load csv
client <- read.csv2("inputs/client.asc",dec = '.')  
#Get gender
client <- mutate(client, 
    gender_code = ifelse(as.numeric(substring(birth_number,3,4)) < 50,0,1),
    gender = ifelse(as.numeric(substring(birth_number,3,4)) < 50,'M','W')
    )
#Get birth date
client <- mutate(client, birth_date = lubridate::make_date(
    year = paste("19",substring(birth_number,1,2),sep = ""),
    month = as.numeric(substring(birth_number,3,4))-50*gender_code,
    day =substring(birth_number,5,6)  
))
save(client, file = 'processed_files/client')
knitr::kable(client[1:10,], caption = 'clients frame')
```

## Disposition

The Disposition relationship contains interactions between customers and accounts, classifying as owner / dependent.
Some explanations of possible account-owner-dependency interactions:
Every account has an owner and may or may not have dependents. Dependents may own another account. A customer may own more than one account.

```{r echo = FALSE}
disposition <- read.csv2("inputs/disp.asc",dec = '.')
knitr::kable(disposition[1:10,], caption = 'disposition frame')
save(disposition, file = 'processed_files/disposition')
```

## Order

List of payment orders issued to accounts. In addition to the money order code and the account code, the records contain information about the bank and account you received, the amount and type of payment (household, insurance, leasing and loan).
To make it easier to understand, it was necessary to translate Czech payment types into English.

```{r echo = FALSE}
order <- read.csv2("inputs/order.asc",dec = '.')  
#Translate names

plyr::revalue(order$k_symbol, c(
  "POJISTNE"='insurance',
  "SIPO"='household',
  "LEASING"='leasing',
  "UVER"='loan'
)) -> order$k_symbol

save(order, file = 'processed_files/order')
knitr::kable(order[1:10,], caption = 'order frame')
```

## Transactions

List of all transactions made by customers, informing:
Account that performed the transaction
Transaction Date
Transaction Type (Inbound and Outbound)
Transaction (credit card withdrawl, credit in cash, collection from another bank, withdrawl in cash, remittance to another bank)
Amount (transaction amount)
Balance after transaction
K-symbol (characterization of transaction)
Bank (receiving bank)
Account (receiving account)

```{r echo = FALSE}

### Transaction frame
transaction <- read.csv2("inputs/trans.asc",dec = '.')

#Get date
transaction <- mutate(transaction,date = lubridate::make_date(
  year = paste("19",substring(date,1,2),sep = ""),
  month = substring(date,3,4),
  day =substring(date,5,6)))

#Translate type
plyr::revalue(transaction$type, c(
  "PRIJEM"='credit',
  "VYDAJ"='withdrawal',
  "VYBER" ='withdrawal'
  
)) -> transaction$type

#Translate operation
plyr::revalue(transaction$operation, c(
  "VYBER KARTOU"='credit card withdrawal',
  "VKLAD" ='credit in cash',
  "PREVOD Z UCTU"='collection from another bank',
  "VYBER"='withdrawal in cash',
  "PREVOD NA UCET"='remittance to another bank'
)) -> transaction$operation

#Translate symbol
plyr::revalue(transaction$k_symbol, c(
  "POJISTNE"='insurrance payment',
  "SLUZBY"='payment for statement',
  "UROK"= 'interest credited',
  "SANKC. UROK"='sanction interest',
  "SIPO"= 'household',
  "DUCHOD"='old age pension',
  "UVER"='loan payment'
)) -> transaction$k_symbol

save(transaction, file = 'processed_files/transaction')
knitr::kable(transaction[1:10,], caption = 'transaction frame')
```

## Loans

Loan list, with 682 occurrences. Each customer can only receive one loan. In the table we have
Loan key
Account Key
Date
Value
Duration (in months)
Installment Payment Amount
Status (finished - ok; Finished - not ok; Running - ok; Running - in debt)
To make understanding easier during the analysis, we classify the status according to its conditions rather than leaving the original groups A through D from the database.

```{r echo = FALSE}
### Loan frame
loan <- read.csv2("inputs/loan.asc",dec = '.')
#Get date
loan <- mutate(loan,date = lubridate::make_date(
  year = paste("19",substring(date,1,2),sep = ""),
  month = substring(date,3,4),
  day =substring(date,5,6)))

plyr::revalue(loan$status, c(
  "A"='Finished - OK',
  "B"='Finished - not payed',
  "C"= 'Running - OK',
  "D"='Running - in Debt'
)) -> loan$status

save(loan, file = 'processed_files/loan')
knitr::kable(loan[1:10,], caption = 'loan frame')
```

## Credit Card

The credit card list contains 892 occurrences and stores the card code, disposition id, card type (junior / classic / gold) and date of issue.
Treatment was performed so that the issue date was in the Brazilian model.

```{r echo = FALSE}

### Credit card frame
card <- read.csv2("inputs/card.asc",dec = '.')
#Get date
card <- mutate(card,issued = lubridate::make_date(
  year = paste("19",substring(issued,1,2),sep = ""),
  month = substring(issued,3,4),
  day =substring(issued,5,6)))

save(card, file = 'processed_files/card')
knitr::kable(card[1:10,], caption = 'card frame')
```

## Demographic data


Finally, demographic data records 77 municipalities distributed in the 7 regions of the Czech Republic.
The table contains the following elements:
District code;

District name;

Region;

Nº of inhabitants

Nº of municipalities with <499 inhabitants

Nº of municipalities with 500-1999 inhabitants

Nº of municipalities with 2000-9999 inhabitants

Nº of municipalities with> 1000 inhabitants

Nº of cities

Proportion of urban inhabitants

Average Salary

unemployment rate ‘95

Unemployment Rate ‘96

Nº of entrepreneurs per 1000 inhabitants

Nº of crimes committed in ‘95

Nº of crimes committed in ‘96

```{r echo = FALSE, warning=FALSE, error=FALSE }

demographic <- read.csv2("inputs/district.asc",dec = '.')
#Change col names
n <- c("district_id","district_name","region","inhabitants","n_size_1",
       "n_size_2","n_size_3","n_size_4","n_cities","ratio of urban inhabitants",
       "average salary","unemploymant rate '95","unemploymant rate '96",
       "enterpreneurs per 1000 inhabitants","commited crimes '95","commited crimes '96")
colnames(demographic) <- n

#Calculate inhabitants by region
#demographic <- left_join(demographic,summarise(group_by(demographic,region), region_inhabitants = sum(inhabitants)), by = 'region')

save(demographic, file = 'processed_files/demographic')
prev <- select(demographic, region, district_name, inhabitants)
knitr::kable(prev[1:10,], caption = 'demographic frame')
```

